<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LINEè²¼åœ–å·¥å…· (å¡é€šé¢¨æ ¼èˆ‡å…©éšæ®µå»èƒŒ)</title>
    <!-- å¼•å…¥ Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- å¼•å…¥ Inter å­—é«” -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        /* è‡ªå®šç¾©æ–¹æ ¼èƒŒæ™¯ CSSï¼Œç”¨æ–¼é è¦½é€æ˜åº¦ */
        .checkered-background {
            background-color: #ffffff;
            background-image: linear-gradient(45deg, #ccc 25%, transparent 25%), 
                              linear-gradient(-45deg, #ccc 25%, transparent 25%),
                              linear-gradient(45deg, transparent 75%, #ccc 75%),
                              linear-gradient(-45deg, transparent 75%, #ccc 75%);
            background-size: 20px 20px;
            background-position: 0 0, 0 10px, 10px -10px, -10px 0px;
        }
    </style>
</head>
<body class="bg-gray-50">

    <div id="app" class="min-h-screen flex flex-col items-center p-4 sm:p-8">
        <h1 class="text-3xl sm:text-4xl font-extrabold text-blue-600 mb-6 text-center">
            LINEè²¼åœ–å·¥å…· (å¡é€šé¢¨æ ¼èˆ‡å…©éšæ®µå»èƒŒ)
        </h1>
        <div class="w-full max-w-4xl bg-white shadow-xl rounded-2xl p-6 sm:p-8">
            
            <!-- ç‹€æ…‹å’ŒéŒ¯èª¤è¨Šæ¯ -->
            <div id="error-message" class="hidden mb-4 p-3 bg-red-100 text-red-700 border border-red-300 rounded-lg font-medium">
                <!-- éŒ¯èª¤è¨Šæ¯å°‡é¡¯ç¤ºåœ¨é€™è£¡ -->
            </div>
            <div id="status-message" class="mb-6 p-3 bg-blue-50 text-blue-700 rounded-lg font-medium">
                ç‹€æ…‹: è«‹ä¸Šå‚³åœ–ç‰‡ä¸¦è¼¸å…¥è²¼åœ–æƒ…å¢ƒã€‚
            </div>

            <!-- è¼¸å…¥å€å¡Š (å·¦å´) -->
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                <!-- 1. åœ–ç‰‡ä¸Šå‚³ -->
                <div class="flex flex-col space-y-4">
                    <label class="block text-lg font-semibold text-gray-700">
                        æ­¥é©Ÿ 1: ä¸Šå‚³åœ–ç‰‡ (ä½œç‚ºè²¼åœ–ä¸»é«”)
                    </label>
                    <div id="upload-area" class="relative border-2 border-dashed border-gray-300 rounded-xl p-6 cursor-pointer hover:border-blue-500 transition duration-300">
                        <input
                            type="file"
                            id="image-upload"
                            accept="image/png, image/jpeg, image/jpg"
                            class="absolute inset-0 w-full h-full opacity-0 cursor-pointer"
                        />
                        <div class="text-center">
                            <svg class="mx-auto h-10 w-10 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 16m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"></path></svg>
                            <p class="mt-1 text-sm text-gray-600">
                                é»æ“Šæˆ–æ‹–æ›³åœ–ç‰‡åˆ°æ­¤è™•ä¸Šå‚³
                            </p>
                            <p id="uploaded-info" class="mt-2 text-sm text-green-500 font-medium hidden">
                                å·²ä¸Šå‚³åœ–ç‰‡
                            </p>
                        </div>
                    </div>
                    <div id="uploaded-preview-container" class="hidden justify-center p-2 border border-gray-200 rounded-lg bg-gray-50">
                        <img id="uploaded-preview" alt="Uploaded Preview" class="max-h-40 w-auto rounded-lg shadow-md object-contain"/>
                    </div>
                </div>

                <!-- 2. æƒ…å¢ƒè¼¸å…¥ -->
                <div class="flex flex-col space-y-4">
                    <label for="prompt" class="block text-lg font-semibold text-gray-700">
                        æ­¥é©Ÿ 2: è¼¸å…¥è²¼åœ–æƒ…å¢ƒ/è¡¨æƒ… (<span class="text-red-500">AI å°‡è¼¸å‡ºå¡é€šé¢¨æ ¼ï¼Œä¸”ä¸æœƒç”Ÿæˆæ–‡å­—</span>)
                    </label>
                    <textarea
                        id="sticker-prompt"
                        rows="3"
                        class="p-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500 resize-none text-gray-800"
                        placeholder="ä¾‹å¦‚ï¼šéœ²å‡ºé©šè¨çš„è¡¨æƒ…ã€æ­£åœ¨å¤§å–Šã€No!ã€ã€ä¸€è‡‰ç„¡å¥ˆåœ°åœ¨å“­æ³£"
                    >éœ²å‡ºé–‹å¿ƒå¤§ç¬‘çš„è¡¨æƒ…</textarea>
                    
                    <!-- 3. ç”Ÿæˆè²¼åœ–æŒ‰éˆ• -->
                    <button
                        id="generate-button"
                        class="w-full py-3 px-4 rounded-xl text-white font-bold transition duration-300 shadow-lg bg-blue-600 hover:bg-blue-700 active:bg-blue-800 shadow-blue-500/50 hover:shadow-blue-500/80 mt-4"
                    >
                        ğŸ¨ éšæ®µä¸€ï¼šç”Ÿæˆå¡é€šè²¼åœ– (å«èƒŒæ™¯)
                    </button>
                </div>
            </div>

            <!-- 4. å»èƒŒæ§åˆ¶å€å¡Š (ç”Ÿæˆå¾Œæ‰é¡¯ç¤º) -->
            <div id="chroma-key-controls" class="mt-8 pt-6 border-t border-gray-200 hidden">
                <h2 class="text-2xl font-semibold text-gray-800 mb-4">
                    éšæ®µäºŒï¼šå»èƒŒè™•ç† (æ‰‹å‹•é¸è‰²)
                </h2>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-6 items-end">
                    <!-- 4a. é¡è‰²é¸æ“‡å™¨ -->
                    <div class="flex flex-col space-y-2">
                        <label for="color-picker" class="block text-base font-semibold text-gray-700 whitespace-nowrap">
                            æ­¥é©Ÿ 4a: é¸å–è¦ç§»é™¤çš„èƒŒæ™¯é¡è‰²
                        </label>
                        <div class="flex items-center space-x-3">
                            <input type="color" id="color-picker" value="#FFFFFF" class="h-10 w-12 rounded-lg border-2 border-gray-300 cursor-pointer">
                            <span class="text-sm text-gray-500">ï¼ˆæ ¹æ“šç”Ÿæˆçš„åœ–ç‰‡èƒŒæ™¯èª¿æ•´ï¼‰</span>
                        </div>
                    </div>

                    <!-- 4b. å®¹å¿åº¦æ§åˆ¶ -->
                    <div class="flex flex-col space-y-2">
                        <label for="tolerance-slider" class="block text-base font-semibold text-gray-700">
                            æ­¥é©Ÿ 4b: å®¹å¿åº¦ (<span id="tolerance-value">30</span>)
                        </label>
                        <input type="range" id="tolerance-slider" min="0" max="100" value="30" class="w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer range-lg">
                        <div class="flex justify-between text-xs text-gray-500">
                            <span>0 (åš´æ ¼ç´”è‰²)</span>
                            <span>100 (æ¥µå¯¬é¬†)</span>
                        </div>
                    </div>

                    <!-- 4c. åŸ·è¡Œå»èƒŒæŒ‰éˆ• -->
                    <button
                        id="remove-bg-button"
                        class="w-full py-3 px-4 rounded-xl text-white font-bold transition duration-300 shadow-lg bg-green-500 hover:bg-green-600 active:bg-green-700 shadow-green-400/50"
                    >
                        âœ‚ï¸ åŸ·è¡Œå»èƒŒ (è®Šé€æ˜)
                    </button>
                </div>
            </div>

            <!-- 5. çµæœé¡¯ç¤ºå€å¡Š -->
            <div class="mt-8 pt-6 border-t border-gray-200">
                <h2 class="text-2xl font-semibold text-gray-800 mb-4">
                    çµæœé è¦½ (æ–¹æ ¼ç‚ºé€æ˜å€åŸŸ)
                </h2>
                <div id="result-area" class="flex justify-center min-h-[300px] items-center bg-gray-100 rounded-xl p-4 border-4 border-dashed border-gray-300 checkered-background">
                    <p id="result-placeholder" class="text-gray-500 italic">è²¼åœ–å°‡åœ¨æ­¤è™•é¡¯ç¤º...</p>
                    <!-- æ–°å¢ä¸€å€‹ Canvas ä¾†é€²è¡Œåœ–ç‰‡è™•ç† -->
                    <canvas id="processing-canvas" class="hidden"></canvas>
                    <img id="generated-sticker" alt="Generated Sticker" class="max-w-full max-h-[400px] w-auto h-auto rounded-lg shadow-2xl transition duration-500 transform hover:scale-105 hidden" style="image-rendering: crisp-edges;"/>
                </div>
                
                <!-- 6. ä¸‹è¼‰æŒ‰éˆ• -->
                <div class="mt-6 flex justify-center">
                    <button
                        id="download-button"
                        class="py-3 px-8 bg-purple-600 hover:bg-purple-700 active:bg-purple-800 text-white font-bold rounded-xl transition duration-300 shadow-lg shadow-purple-400/50 flex items-center space-x-2 hidden"
                    >
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"></path></svg>
                        ä¸‹è¼‰é€æ˜ PNG è²¼åœ–
                    </button>
                </div>
            </div>

            <!-- é¡¯ç¤ºç”¨æˆ¶ ID (Canvas Requirement) -->
            <div class="mt-8 border-t pt-4 text-xs text-gray-400 text-center">
                ç”¨æˆ¶ID: <span id="user-id-display">é©—è­‰ä¸­...</span>
            </div>
        </div>
    </div>

    <!-- Firebase æ¨¡çµ„å¼•ç”¨ -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // å…¨å±€ç‹€æ…‹è®Šæ•¸
        const state = {
            uploadedImageBase64: null,
            generatedImageBase64: null, // AI ç”Ÿæˆçš„åŸå§‹åœ–ç‰‡ (å«èƒŒæ™¯)
            processedStickerUrl: null, // ç¶“éå»èƒŒè™•ç†çš„åœ–ç‰‡ (é€æ˜èƒŒæ™¯)
            isLoading: false,
            authReady: false,
            userId: null
        };

        // DOM å…ƒç´ å¼•ç”¨
        const elements = {
            statusMessage: document.getElementById('status-message'),
            errorMessage: document.getElementById('error-message'),
            imageUpload: document.getElementById('image-upload'),
            stickerPrompt: document.getElementById('sticker-prompt'),
            generateButton: document.getElementById('generate-button'),
            removeBgButton: document.getElementById('remove-bg-button'), // å»èƒŒæŒ‰éˆ•
            downloadButton: document.getElementById('download-button'),
            uploadedInfo: document.getElementById('uploaded-info'),
            uploadedPreview: document.getElementById('uploaded-preview'),
            uploadedPreviewContainer: document.getElementById('uploaded-preview-container'),
            generatedSticker: document.getElementById('generated-sticker'),
            resultPlaceholder: document.getElementById('result-placeholder'),
            userIdDisplay: document.getElementById('user-id-display'),
            processingCanvas: document.getElementById('processing-canvas'), 
            colorPicker: document.getElementById('color-picker'), 
            toleranceSlider: document.getElementById('tolerance-slider'), 
            toleranceValue: document.getElementById('tolerance-value'), 
            chromaKeyControls: document.getElementById('chroma-key-controls'), // å»èƒŒæ§åˆ¶å€å¡Š
        };

        // UI ç‹€æ…‹æ›´æ–°å‡½æ•¸
        function updateUI() {
            // --- æŒ‰éˆ•ç‹€æ…‹ ---
            elements.generateButton.disabled = state.isLoading || !state.uploadedImageBase64 || !elements.stickerPrompt.value.trim();
            elements.removeBgButton.disabled = state.isLoading || !state.generatedImageBase64;
            elements.imageUpload.disabled = state.isLoading;
            elements.stickerPrompt.disabled = state.isLoading;
            
            // --- å®¹å¿åº¦é¡¯ç¤ºå€¼ ---
            elements.toleranceValue.textContent = elements.toleranceSlider.value;

            // --- éšæ®µä¸€æŒ‰éˆ• (ç”Ÿæˆ) ---
            if (state.isLoading) {
                elements.generateButton.innerHTML = `
                    <span class="flex items-center justify-center">
                        <svg class="animate-spin -ml-1 mr-3 h-5 w-5 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                            <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                        </svg>
                        ç”Ÿæˆä¸­... (AI é‹ç®—ä¸­)
                    </span>
                `;
                elements.generateButton.classList.remove('bg-blue-600', 'hover:bg-blue-700', 'active:bg-blue-800');
                elements.generateButton.classList.add('bg-blue-400', 'cursor-not-allowed');
            } else {
                elements.generateButton.textContent = "ğŸ¨ éšæ®µä¸€ï¼šç”Ÿæˆå¡é€šè²¼åœ– (å«èƒŒæ™¯)";
                elements.generateButton.classList.remove('bg-blue-400', 'cursor-not-allowed');
                elements.generateButton.classList.add('bg-blue-600', 'hover:bg-blue-700', 'active:bg-blue-800');
            }

            // --- ä¸‹è¼‰æŒ‰éˆ• ---
            // åªæœ‰åœ¨å®Œæˆå»èƒŒè™•ç†å¾Œæ‰èƒ½ä¸‹è¼‰ (å³ state.processedStickerUrl å­˜åœ¨)
            if (state.processedStickerUrl) {
                elements.downloadButton.classList.remove('hidden');
            } else {
                elements.downloadButton.classList.add('hidden');
            }

            // --- å»èƒŒæ§åˆ¶å€å¡Šé¡¯ç¤º/éš±è— ---
            // åªæœ‰åœ¨ AI ç”Ÿæˆåœ–ç‰‡å®Œæˆå¾Œæ‰é¡¯ç¤º
            if (state.generatedImageBase64) {
                elements.chromaKeyControls.classList.remove('hidden');
            } else {
                elements.chromaKeyControls.classList.add('hidden');
            }

            // --- è²¼åœ–é è¦½ ---
            // å„ªå…ˆé¡¯ç¤ºå·²è™•ç† (é€æ˜) åœ–ç‰‡ï¼Œå…¶æ¬¡æ˜¯ AI ç”Ÿæˆçš„åŸå§‹åœ–ç‰‡
            const currentPreviewUrl = state.processedStickerUrl || state.generatedImageBase64;
            if (currentPreviewUrl) {
                elements.generatedSticker.src = currentPreviewUrl;
                elements.generatedSticker.classList.remove('hidden');
                elements.resultPlaceholder.classList.add('hidden');
                
            } else {
                elements.generatedSticker.classList.add('hidden');
                elements.resultPlaceholder.classList.remove('hidden');
                
                if (state.uploadedImageBase64 && !state.isLoading) {
                     elements.resultPlaceholder.textContent = 'é»æ“Šã€Œéšæ®µä¸€ï¼šç”Ÿæˆå¡é€šè²¼åœ–ã€æŒ‰éˆ•é–‹å§‹å‰µä½œã€‚';
                } else if (!state.isLoading) {
                     elements.resultPlaceholder.textContent = 'è²¼åœ–å°‡åœ¨æ­¤è™•é¡¯ç¤º...';
                }
            }
        }
        
        function setError(msg) {
            elements.errorMessage.textContent = 'éŒ¯èª¤: ' + msg;
            elements.errorMessage.classList.remove('hidden');
        }

        function clearError() {
            elements.errorMessage.classList.add('hidden');
            elements.errorMessage.textContent = '';
        }

        function setMessage(msg) {
            elements.statusMessage.textContent = 'ç‹€æ…‹: ' + msg;
        }

        // --- å·¥å…·å‡½æ•¸ ---
        function fileToBase64(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.readAsDataURL(file);
                reader.onload = () => resolve(reader.result.split(',')[1]); 
                reader.onerror = (error) => reject(error);
            });
        }

        function hexToRgb(hex) {
            const shorthandRegex = /^#?([a-f\d])([a-f\d])([a-f\d])$/i;
            hex = hex.replace(shorthandRegex, (m, r, g, b) => r + r + g + g + b + b);
            const result = /^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(hex);
            return result ? {
                r: parseInt(result[1], 16),
                g: parseInt(result[2], 16),
                b: parseInt(result[3], 16)
            } : {r: 255, g: 255, b: 255}; 
        }

        async function fetchWithRetry(url, options, maxRetries = 5) {
            for (let attempt = 0; attempt < maxRetries; attempt++) {
                try {
                    const response = await fetch(url, options);
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    return response;
                } catch (error) {
                    if (attempt === maxRetries - 1) {
                        throw error;
                    }
                    const delay = Math.pow(2, attempt) * 1000;
                    await new Promise(resolve => setTimeout(resolve, delay));
                }
            }
        }

        // --- è™•ç†ç¨‹åº ---

        // è™•ç†åœ–ç‰‡ä¸Šå‚³
        async function handleImageUpload(event) {
            const file = event.target.files[0];
            if (file) {
                if (!file.type.startsWith('image/')) {
                    setError("è«‹ä¸Šå‚³åœ–ç‰‡æª”æ¡ˆ (PNG, JPG)ã€‚");
                    return;
                }
                if (file.size > 5 * 1024 * 1024) { 
                    setError("åœ–ç‰‡å¤§å°ä¸èƒ½è¶…é 5MBã€‚");
                    return;
                }
                try {
                    const base64 = await fileToBase64(file);
                    state.uploadedImageBase64 = { data: base64, mimeType: file.type };
                    state.generatedImageBase64 = null;
                    state.processedStickerUrl = null;
                    
                    clearError();
                    setMessage("åœ–ç‰‡ä¸Šå‚³æˆåŠŸï¼è«‹è¼¸å…¥æƒ…å¢ƒä¸¦é»æ“Šç”Ÿæˆã€‚");
                    
                    elements.uploadedPreview.src = `data:${file.type};base64,${base64}`;
                    elements.uploadedPreviewContainer.classList.remove('hidden');
                    elements.uploadedInfo.classList.remove('hidden');
                    elements.uploadedInfo.textContent = `å·²ä¸Šå‚³åœ–ç‰‡ (Mime Type: ${file.type})`;
                } catch (e) {
                    console.error("Error reading file:", e);
                    setError("è®€å–åœ–ç‰‡å¤±æ•—ï¼Œè«‹é‡è©¦ã€‚");
                }
            }
            updateUI();
        }

        // éšæ®µä¸€ï¼šå‘¼å«æ‚¨çš„ä»£ç†ä¼ºæœå™¨é€²è¡Œè²¼åœ–ç”Ÿæˆ
        async function generateSticker() {
            if (!state.uploadedImageBase64) {
                setError("è«‹å…ˆä¸Šå‚³åœ–ç‰‡ï¼");
                return;
            }

            state.isLoading = true;
            state.generatedImageBase64 = null;
            state.processedStickerUrl = null;
            clearError();
            setMessage("AI æ­£åœ¨ç‚ºæ‚¨ç”Ÿæˆå¡é€šè²¼åœ–ï¼Œè«‹ç¨å€™...");
            updateUI();
            
            const stickerPrompt = elements.stickerPrompt.value;
            // æ ¸å¿ƒæŒ‡ä»¤ï¼šå¼·åˆ¶åŠ å…¥å¡é€šé¢¨æ ¼å’Œå‘é‡è—è¡“
            const promptText = `
                Based on the uploaded image, generate a new image in the style of a very cute, high-quality, **cartoon-style, vector art** LINE sticker.
                The subject in the image should fully reflect this expression/scenario: "${stickerPrompt}".
                ***IMPORTANT: DO NOT generate any text, dialogue, speech bubbles, or captions in the image. Only visual elements of the sticker.***
                Crucially, the final image MUST have a PURE SINGLE-COLOR BACKGROUND (any color, like white, blue, or red). 
                The subject MUST have sharp and clean edges, and incorporate a thick, PURE WHITE border around the main subject, as is standard for professional stickers.
                The subject must be clean and clearly defined for sticker use.
                Output ONLY the resulting image.
            `;

            // *** è®ŠåŒ–é» 1: å‘¼å«ç›¸å°è·¯å¾‘çš„ API ä»£ç† ***
            const apiUrl = `/api/generate`; 
            
            // *** è®ŠåŒ–é» 2: å‚³é€å®Œæ•´çš„è«‹æ±‚ Payload ***
            const payload = {
                promptText: promptText, // å°‡æŒ‡ä»¤æ–‡å­—ä½œç‚ºå–®ç¨çš„éµå‚³é€
                image: state.uploadedImageBase64, // å‚³é€åœ–ç‰‡æ•¸æ“š
                model: "gemini-2.5-flash-image-preview" // å‚³é€æ¨¡å‹åç¨±
            };


            try {
                const response = await fetchWithRetry(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                const result = await response.json();

                const base64Data = result?.base64Data; // å‡è¨­ä»£ç†æœå‹™æœƒå›å‚³ base64Data éµ

                if (base64Data) {
                    const generatedUrl = `data:image/png;base64,${base64Data}`;
                    
                    state.generatedImageBase64 = generatedUrl; // å„²å­˜åŸå§‹ç”Ÿæˆåœ–
                    state.processedStickerUrl = null; // æ¸…é™¤èˆŠçš„é€æ˜åœ–
                    setMessage("è²¼åœ–å·²ç”Ÿæˆï¼è«‹åœ¨éšæ®µäºŒä¸­é¸å–èƒŒæ™¯è‰²ä¸¦å»èƒŒã€‚");
                } else {
                    console.error("API response lacked image data or returned error:", result);
                    setError(`AI ç”Ÿæˆå¤±æ•—æˆ–ä»£ç†æœå‹™éŒ¯èª¤: ${result.error || 'æœªçŸ¥éŒ¯èª¤'}`);
                }

            } catch (e) {
                console.error("API call error:", e);
                // ç”±æ–¼å·²ç¶“æ˜¯ä»£ç†æœå‹™ï¼Œ403 éŒ¯èª¤ç¾åœ¨å¯èƒ½è¡¨ç¤ºä»£ç†æœå‹™æœ¬èº«æœ‰å•é¡Œ
                setError(`å‘¼å«ä»£ç†æœå‹™å¤±æ•—: ${e.message}ã€‚è«‹ç¢ºèªå¾Œç«¯ Serverless Function å·²æ­£ç¢ºéƒ¨ç½²ã€‚`);
            } finally {
                state.isLoading = false;
                updateUI();
            }
        }

        // éšæ®µäºŒï¼šåŸ·è¡Œå»èƒŒè™•ç† (æ­¤è™•ç‚ºç´”å‰ç«¯ Canvas è™•ç†ï¼Œç„¡éœ€ä¿®æ”¹)
        async function removeBackground() {
            if (!state.generatedImageBase64) {
                setError("è«‹å…ˆå®Œæˆéšæ®µä¸€ï¼šç”Ÿæˆåœ–ç‰‡ã€‚");
                return;
            }

            state.isLoading = true;
            setMessage("æ­£åœ¨åŸ·è¡Œå»èƒŒè™•ç†...");
            updateUI();

            try {
                // å–å¾—ç›®æ¨™é¡è‰² (å¾é¸æ“‡å™¨ç²å–ä¸¦è½‰æ›ç‚º RGB)
                const colorHex = elements.colorPicker.value;
                const targetRgb = hexToRgb(colorHex);
                // è¨­ç½®å®¹å¿åº¦ (å¾æ»‘æ¡¿ç²å–å€¼ï¼Œæ˜ å°„åˆ° 0-255)
                const tolerance = parseInt(elements.toleranceSlider.value, 10) * 2.55; 

                // å‘¼å«å»èƒŒå‡½å¼
                const transparentUrl = await processImageForTransparency(state.generatedImageBase64, targetRgb, tolerance);
                
                state.processedStickerUrl = transparentUrl;
                setMessage("å»èƒŒè™•ç†å®Œæˆï¼å¯é»æ“Šä¸‹è¼‰æŒ‰éˆ•ä¿å­˜ã€‚");

            } catch (e) {
                console.error("å»èƒŒè™•ç†å¤±æ•—:", e);
                setError("å»èƒŒè™•ç†å¤±æ•—ï¼Œè«‹ç¢ºèªé¸æ“‡çš„èƒŒæ™¯è‰²èˆ‡å®¹å¿åº¦ã€‚");
            } finally {
                state.isLoading = false;
                updateUI();
            }
        }

        /**
         * å¼·åˆ¶å°‡åœ–ç‰‡ä¸­æ¥è¿‘é¸å®šé¡è‰² (è€ƒæ…®å®¹å¿åº¦) çš„åƒç´ è½‰æ›ç‚ºé€æ˜ã€‚
         */
        function processImageForTransparency(base64Image, targetRgb, tolerance) {
            return new Promise((resolve, reject) => {
                const img = new Image();
                img.crossOrigin = "Anonymous"; 
                
                img.onload = () => {
                    const canvas = elements.processingCanvas;
                    const ctx = canvas.getContext('2d');

                    canvas.width = img.width;
                    canvas.height = img.height;
                    
                    // æ¸…ç©º Canvas ä¸¦ç¹ªè£½åœ–ç‰‡
                    ctx.clearRect(0, 0, canvas.width, canvas.height);
                    ctx.drawImage(img, 0, 0);

                    // å–å¾—åœ–ç‰‡åƒç´ è³‡æ–™
                    const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
                    const data = imageData.data;

                    // è¿­ä»£æ‰€æœ‰åƒç´ 
                    for (let i = 0; i < data.length; i += 4) {
                        const red = data[i];     
                        const green = data[i+1]; 
                        const blue = data[i+2];  

                        // è¨ˆç®—èˆ‡ç›®æ¨™é¡è‰²çš„å·®ç•°
                        const rDiff = Math.abs(red - targetRgb.r);
                        const gDiff = Math.abs(green - targetRgb.g);
                        const bDiff = Math.abs(blue - targetRgb.b);

                        // ä½¿ç”¨æœ€å¤§å·®ç•°ä¾†åˆ¤æ–·æ˜¯å¦ç‚ºèƒŒæ™¯è‰²
                        const maxDiff = Math.max(rDiff, gDiff, bDiff);
                        
                        if (maxDiff <= tolerance) {
                            // å°‡ Alpha é€šé“è¨­ç‚º 0 (å®Œå…¨é€æ˜)
                            data[i+3] = 0; 
                        }
                    }

                    // å°‡ä¿®æ”¹å¾Œçš„åƒç´ è³‡æ–™æ”¾å› Canvas
                    ctx.putImageData(imageData, 0, 0);

                    // è½‰æ›ç‚º PNG æ•¸æ“š URL (ç¢ºä¿ä¿ç•™é€æ˜åº¦)
                    const processedUrl = canvas.toDataURL('image/png');
                    resolve(processedUrl);
                };
                img.onerror = () => {
                    reject(new Error("Error loading image for transparency processing."));
                }
                img.src = base64Image;
            });
        }

        // è™•ç†ä¸‹è¼‰ (ä½¿ç”¨ Base64 æ•¸æ“š)
        function handleDownload() {
            if (state.processedStickerUrl) {
                const link = document.createElement('a');
                link.href = state.processedStickerUrl;
                link.download = `LINE_Sticker_Cartoon_${Date.now()}.png`;
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                setMessage("è²¼åœ–å·²é–‹å§‹ä¸‹è¼‰ï¼");
            } else {
                setError("æ²’æœ‰å¯ä¾›ä¸‹è¼‰çš„é€æ˜è²¼åœ–ã€‚è«‹å…ˆå®Œæˆéšæ®µä¸€å’Œéšæ®µäºŒã€‚");
            }
        }

        // Firebase åˆå§‹åŒ–èˆ‡èªè­‰
        window.onload = async () => {
            try {
                const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {};
                const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

                if (Object.keys(firebaseConfig).length > 0) {
                    const app = initializeApp(firebaseConfig);
                    const auth = getAuth(app);
                    getFirestore(app); 

                    onAuthStateChanged(auth, async (user) => {
                        if (user) {
                            state.userId = user.uid;
                            elements.userIdDisplay.textContent = user.uid;
                        } else {
                            if (initialAuthToken) {
                                await signInWithCustomToken(auth, initialAuthToken);
                            } else {
                                await signInAnonymously(auth);
                            }
                        }
                        state.authReady = true;
                        updateUI();
                    });
                } else {
                    state.userId = crypto.randomUUID();
                    elements.userIdDisplay.textContent = state.userId + " (åŒ¿å)";
                    state.authReady = true;
                    updateUI();
                }

                // ç¶å®šäº‹ä»¶ç›£è½å™¨
                elements.imageUpload.addEventListener('change', handleImageUpload);
                elements.generateButton.addEventListener('click', generateSticker);
                elements.removeBgButton.addEventListener('click', removeBackground); // ç¶å®šå»èƒŒæŒ‰éˆ•
                elements.downloadButton.addEventListener('click', handleDownload);
                elements.stickerPrompt.addEventListener('input', updateUI);
                elements.toleranceSlider.addEventListener('input', updateUI); 
                elements.colorPicker.addEventListener('change', updateUI); 

                updateUI(); // åˆå§‹ UI æ¸²æŸ“
                
            } catch (e) {
                console.error("æ‡‰ç”¨ç¨‹å¼åˆå§‹åŒ–å¤±æ•—:", e);
                setError("æ‡‰ç”¨ç¨‹å¼åˆå§‹åŒ–å¤±æ•—ã€‚è«‹æª¢æŸ¥æ§åˆ¶å°éŒ¯èª¤ã€‚");
            }
        };
    </script>
</body>
</html>